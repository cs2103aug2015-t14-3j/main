import java.util.ArrayList;
import java.util.Date;
import java.util.HashMap;
import java.io.BufferedReader;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;
import java.text.SimpleDateFormat;
import java.util.Map;

abstract class Logic {

	abstract public String welcomeMessage1();
	abstract public String welcomeMessage2();
	abstract public String toDoToday();
	abstract public String executeCommand(String command);
	abstract public void setUserName(String userName);
	abstract public String getUserName();
}

class TBLogic extends Logic {
	
	private String output;
	private String date;
	private String userName;
	private String namePath = "UserName.txt";
	ArrayList<Map<String, String>> tasks;

	
//	private Storage storage;
//	private History      ;
	private Parser parser;
	private Helper helper = new Helper();
	
	private final String WELCOME_MESSAGE1 = "Date: %s\nTime: %s\n--------------------\n";
	private final String WELCOME_MESSAGE2 = "Welcome back, %s!\n";
	private final String INVALID_COMMAND = "Invalid Command\n";
	private final String DISPLAY_HEADER = "Here is your schedule for %s:\n\n  Description       Start Date          End Date\n";
	private final String DISPLAY_FORMAT = "%d.%-18s%-20s%s\n";
	
	public TBLogic() {
		output = new String();
		parser = new Parser();
//		storage = new Storage();
		getUserNameFromMemory();
	}
	
	//To be refactored
	private void getUserNameFromMemory() {
		
		File fileToRead = new File(namePath);
		try{
		BufferedReader reader = new BufferedReader(new FileReader(fileToRead));
		userName = reader.readLine();
		reader.close();
		} catch (FileNotFoundException ex) {
		userName = null;
		//Creates an empty file at path
		try{
			PrintWriter writer = new PrintWriter(new FileWriter(fileToRead));
			writer.close();
			} catch (IOException ex2) {
			System.out.println(ex2);
			}

		} catch (IOException ex) {
		System.out.println(ex);
		}
	}
	
	//To be refactored
	public void setUserName(String userName) {
		this.userName = userName;
		
		File file = new File(namePath);
		
		//Clears the file
		try{
		PrintWriter writer = new PrintWriter(new FileWriter(file));
		writer.close();
		} catch (IOException ex) {
		System.out.println(ex);
		}
		
		//Writes username to file
		try{
			PrintWriter writer = new PrintWriter(new FileWriter(file, true));
			writer.println(userName);
			writer.close();
			} catch (IOException ex) {
			System.out.println(ex);
			}

	}
	
	public String getUserName() {
		return userName;
	}
	
	public String welcomeMessage2() {
		output = String.format(WELCOME_MESSAGE2, userName);
		return output;
	}
	
	public String welcomeMessage1() {
		Date dateTime = new Date();
		SimpleDateFormat dateFormat = new SimpleDateFormat("dd MMMM yyyy, EEEE");
		SimpleDateFormat timeFormat = new SimpleDateFormat("HH:mm:ss");
		
		date = dateFormat.format(dateTime);
		String time = timeFormat.format(dateTime);
		
		output = String.format(WELCOME_MESSAGE1, date, time);
		return output;
	}
	
	public String toDoToday() {
		output = String.format(DISPLAY_HEADER, "today");
		int index = 1;
		
//		Map<String, String> command = new HashMap<String, String> ();
		
//		command.put("subCommand", "on");
//		command.put("data", date);
//		output = display(command);
//		
//		return output;
		
		output += String.format(DISPLAY_FORMAT, index, "submit report", "20/9/2015", "21/9/2015");

		output += "\n";
		return output;
	}
	
	public String executeCommand(String command) {
		Map<String, String> parsedCommand = parser.getDictionary(command);
		
		String commandType = parsedCommand.get("command");
		
		switch (commandType) {
		case "add":
			output = add(parsedCommand);
			return output;
		case "display":
			output = display(parsedCommand);
			return output;
		case "delete":
			output = delete(parsedCommand);
			return output;			
		case "edit":
			output = edit(parsedCommand);
			return output;
		case "search":
			output = search(parsedCommand);
			return output;
		case "undo":
			output = undo(parsedCommand);
			return output;
		case "help":
			output = help(parsedCommand);
			return output;
		default:
			return " ";
//		case INVALID:
//			output = INVALID_COMMAND;
//			return output;
		}
	}
	
	private String add(Map<String, String> parsedCommand) {
		String description = parsedCommand.get("description");
		String startDate = parsedCommand.get("startDate");
		String endDate = parsedCommand.get("endDate");
		
		if (endDate == null) {
			//Floating Task
		} else if (startDate == null) {
			//DeadLine
		} else {
			//Event
		}
		
		return "add " + "description: " + description + " start: " + startDate + " end: " + endDate + "\n";
	}
	
	private String display(Map<String, String> parsedCommand) {
		String subCommand = parsedCommand.get("subCommand");
		String date = parsedCommand.get("date");
		 
		
		if (subCommand == null) {
			//Display All
		} else {
			switch (subCommand) {
			case "on":
//				tasks = 
//				break;
			case "from":
//				tasks = 
//				break;
			case "after":
//				tasks = 
//				break;
			case "due":
//				tasks = 
//				break;
			case "incomplete":
//				tasks = 
//				break;
			case "floating":
//				tasks = 
//				break;
			default:
				return INVALID_COMMAND;
			}
		}
		
//		output = String.format(DISPLAY_HEADER, "today");
//		int index = 1;
		
//		int i = 0;
		
//		for (i = 0; i < tasks.size(); ++i) {
//			Map<String,String> task = tasks.get(i);
			
//			String description = task.get("description");
//			String start = task.get("start");
//			String end = task.get("end");
			
//			output += String.format(DISPLAY_FORMAT, index, description, start, end);			
//		}
		
//		output += "\n";
//		return output;

		
		return "display " + "sub: " + subCommand + " date: " + date + "\n";
	}
	
	private String delete(Map<String,String> parsedCommand) {
		String index = parsedCommand.get("index");
		
		return "delete " + "index: " + index + "\n";
	}
	
	private String edit(Map<String, String> parsedCommand) {
		String index = parsedCommand.get("index");
		String field = parsedCommand.get("field");
		String value = parsedCommand.get("value");
		
		return "edit " + "index: " + index + " field: " + field + " value: " + value + "\n";
	}
	
	private String search(Map<String, String> parsedCommand) {
		String text = parsedCommand.get("text");
		
		return "search " + " text: " + text + "\n";
	}
	
	private String undo(Map<String, String> parsedCommand) {
		return "undo\n";
	}
	
	private String help(Map<String, String> parsedCommand) {
		String target = parsedCommand.get("target");

		return helper.help(target);
		
//		return "help " + "target: " + target + "\n";
	}

}